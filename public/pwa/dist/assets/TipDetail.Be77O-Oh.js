import{d as e,e as t,v as a,f as s,k as o,j as i,t as r,F as l,i as n,E as c,G as m,r as d,b as u,m as p,h as v,u as g,o as h}from"./vendor.BeqKZlTx.js";import{u as y,a as f}from"./api.DeptcIQc.js";import{_ as b,S as k,a as C}from"./index.C1mfdDgG.js";import{B as w}from"./Badge.QpPmjZQE.js";import{A as _}from"./AuthModal.CAYITUsz.js";const x={class:"tip-detail"},A={class:"md3-main-content"},E={key:0,class:"loading-container"},D={key:1,class:"tip-content"},S={key:0,class:"tip-hero"},M=["src","alt"],j={class:"tip-overlay dinor-gradient-primary"},L={class:"tip-badges"},I={class:"tip-info"},$={class:"tip-stats"},T={class:"stat-item"},R={class:"md3-body-medium"},B={class:"stat-item"},F={class:"md3-body-medium"},V={class:"stat-item"},z={class:"md3-body-medium"},H={key:0,class:"tip-summary-video"},U={class:"video-container"},q=["src","title"],G={class:"tip-content-text"},P=["innerHTML"],N={key:1,class:"tip-tags"},O={class:"tags-container"},J={class:"comments-section"},K={class:"md3-title-medium dinor-text-primary"},Q={class:"add-comment-form"},W={key:0,class:"auth-prompt"},X={key:1},Y={class:"authenticated-user"},Z={class:"user-info"},ee=["disabled"],te={key:0,class:"comments-list"},ae={class:"comment-header"},se={class:"comment-meta"},oe={class:"comment-author md3-body-medium"},ie={class:"comment-date md3-body-small dinor-text-gray"},re={key:0,class:"comment-actions"},le=["onClick"],ne={class:"comment-content md3-body-medium"},ce={key:1,class:"empty-comments"},me={key:2,class:"error-state"},de={class:"error-actions"};const ue=b({name:"TipDetail",emits:["update-header"],components:{Badge:w,ShareModal:k,AuthModal:_},props:{id:{type:String,required:!0}},setup(e,{emit:t}){const a=v();g();const s=y(),o=f(),{showShareModal:i,updateOpenGraphTags:r}=C(),l=d(null),n=d([]),c=d(!0),m=d(!1),h=d(!1),b=d(""),k=d(!1),w=u(()=>l.value?{title:l.value.title,text:`Découvrez cette astuce pratique : ${l.value.title}`,url:window.location.href,image:l.value.image,type:"tip",id:l.value.id}:{}),_=async()=>{try{console.log("🔄 [Comments] Chargement des commentaires pour tip ID:",e.id);const t=await s.get("/comments",{commentable_type:"App\\Models\\Tip",commentable_id:e.id});console.log("📥 [Comments] Réponse reçue:",t),t.success&&(n.value=t.data,console.log("✅ [Comments] Commentaires chargés:",n.value.length,"commentaires"))}catch(t){console.error("❌ [Comments] Erreur lors du chargement des commentaires:",t)}},x=async()=>{try{console.log("🔄 [Comments] Rechargement FRAIS des commentaires pour tip ID:",e.id);const t=await s.getFresh("/comments",{commentable_type:"App\\Models\\Tip",commentable_id:e.id});console.log("📥 [Comments] Réponse fraîche reçue:",t),t.success&&(n.value=t.data,console.log("✅ [Comments] Commentaires frais chargés:",n.value.length,"commentaires"))}catch(t){console.error("❌ [Comments] Erreur lors du rechargement frais des commentaires:",t)}},A=async()=>{try{const t=await s.get("/likes/check",{type:"tip",id:e.id});m.value=t.success&&t.is_liked}catch(t){console.error("Erreur lors de la vérification du like:",t)}},E=async()=>{try{const t=await s.get("/favorites/check",{type:"tip",id:e.id});h.value=t.success&&t.is_favorited}catch(t){console.error("Erreur lors de la vérification du favori:",t)}};return p(()=>{(async()=>{try{const a=await s.get(`/tips/${e.id}`);a.success&&(l.value=a.data,await _(),await A(),await E(),r(w.value),t("update-header",{title:l.value.title||"Astuce",showShare:!0,showLike:!0,isLiked:m.value,backPath:"/tips"}))}catch(a){console.error("Erreur lors du chargement de l'astuce:",a)}finally{c.value=!1}})()}),{tip:l,comments:n,loading:c,userLiked:m,userFavorited:h,newComment:b,toggleLike:async()=>{try{const a=await s.post("/likes/toggle",{likeable_type:"tip",likeable_id:e.id});a.success&&(m.value=!m.value,l.value&&(l.value.likes_count=a.data.total_likes),t("update-header",{isLiked:m.value}))}catch(a){console.error("Erreur lors du toggle like:",a)}},toggleFavorite:async()=>{try{const a=await s.post("/favorites/toggle",{favoritable_type:"tip",favoritable_id:e.id});a.success&&(h.value=!h.value,l.value&&(l.value.favorites_count=a.data.total_favorites),t("update-header",{isFavorited:h.value}))}catch(a){console.error("Erreur lors du toggle favori:",a)}},addComment:async()=>{if(b.value.trim())if(o.isAuthenticated)try{const t={commentable_type:"App\\Models\\Tip",commentable_id:parseInt(e.id),content:b.value};console.log("📝 [Comments] Envoi du commentaire:",t);(await s.post("/comments",t)).success&&(console.log("✅ [Comments] Commentaire ajouté avec succès"),await x(),b.value="")}catch(t){console.error("❌ [Comments] Erreur lors de l'ajout du commentaire:",t),t.message.includes("401")&&(k.value=!0)}else k.value=!0},canDeleteComment:e=>{var t;return!!o.isAuthenticated&&!(!e.user_id||e.user_id!==(null==(t=o.user)?void 0:t.id))},deleteComment:async e=>{if(confirm("Êtes-vous sûr de vouloir supprimer ce commentaire ?"))try{console.log("🗑️ [Comments] Suppression du commentaire ID:",e);(await s.request(`/comments/${e}`,{method:"DELETE"})).success&&(console.log("✅ [Comments] Commentaire supprimé avec succès"),await x())}catch(t){console.error("❌ [Comments] Erreur lors de la suppression du commentaire:",t),alert("Erreur lors de la suppression du commentaire")}},goBack:()=>{a.push("/tips")},goHome:()=>{a.push("/")},getDifficultyLabel:e=>({beginner:"Débutant",intermediate:"Intermédiaire",advanced:"Avancé"}[e]||"Débutant"),formatDate:e=>new Date(e).toLocaleDateString("fr-FR"),handleImageError:e=>{e.target.src="/images/default-recipe.jpg"},formatContent:e=>e?"string"==typeof e?e:Array.isArray(e)?e.map((e,t)=>"object"==typeof e&&e.step?`<div class="content-step">\n              <h4>Étape ${t+1}</h4>\n              <p>${e.step}</p>\n            </div>`:"string"==typeof e?`<div class="content-step">\n              <p>${e}</p>\n            </div>`:`<div class="content-step"><p>${e}</p></div>`).join(""):e.toString():"",getEmbedUrl:e=>{if(!e||!e.trim())return"";const t=e.trim(),a=t.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&\n?#]+)/);if(a)return`https://www.youtube.com/embed/${a[1]}?rel=0&modestbranding=1`;const s=t.match(/vimeo\.com\/(\d+)/);return s?`https://player.vimeo.com/video/${s[1]}`:t},showShareModal:i,shareData:w,authStore:o,showAuthModal:k}}},[["render",function(d,u,p,v,g,y){const f=i("Badge"),b=i("ShareModal"),k=i("AuthModal");return h(),e("div",x,[t("main",A,[v.loading?(h(),e("div",E,u[9]||(u[9]=[t("div",{class:"md3-circular-progress"},null,-1),t("p",{class:"md3-body-large"},"Chargement de l'astuce...",-1)]))):v.tip?(h(),e("div",D,[v.tip.image?(h(),e("div",S,[t("img",{src:v.tip.image||"/images/default-recipe.jpg",alt:v.tip.title,class:"tip-hero-image",onError:u[0]||(u[0]=(...e)=>v.handleImageError&&v.handleImageError(...e))},null,40,M),t("div",j,[t("div",L,[v.tip.difficulty_level?(h(),o(f,{key:0,text:v.getDifficultyLabel(v.tip.difficulty_level),icon:"lightbulb",variant:"secondary",size:"medium"},null,8,["text"])):s("",!0),v.tip.category?(h(),o(f,{key:1,text:v.tip.category.name,icon:"tag",variant:"neutral",size:"medium"},null,8,["text"])):s("",!0)])])])):s("",!0),t("div",I,[t("div",$,[t("div",T,[u[10]||(u[10]=t("i",{class:"material-icons dinor-text-secondary"},"schedule",-1)),t("span",R,r(v.tip.estimated_time)+"min",1)]),t("div",B,[u[11]||(u[11]=t("i",{class:"material-icons dinor-text-secondary"},"favorite",-1)),t("span",F,r(v.tip.likes_count||0),1)]),t("div",V,[u[12]||(u[12]=t("i",{class:"material-icons dinor-text-secondary"},"comment",-1)),t("span",z,r(v.tip.comments_count||0),1)])]),v.tip.summary_video_url&&v.tip.summary_video_url.trim()?(h(),e("div",H,[u[13]||(u[13]=t("h2",{class:"md3-title-medium dinor-text-primary"},"Résumé en vidéo",-1)),t("div",U,[t("iframe",{src:v.getEmbedUrl(v.tip.summary_video_url),title:`Résumé vidéo : ${v.tip.title}`,frameborder:"0",allowfullscreen:"",class:"summary-video-iframe"},null,8,q)])])):s("",!0),t("div",G,[u[14]||(u[14]=t("h2",{class:"md3-title-medium dinor-text-primary"},"Astuce",-1)),t("div",{class:"md3-body-large dinor-text-gray",innerHTML:v.formatContent(v.tip.content)},null,8,P)]),v.tip.tags&&v.tip.tags.length?(h(),e("div",N,[u[15]||(u[15]=t("h3",{class:"md3-title-small dinor-text-primary"},"Tags",-1)),t("div",O,[(h(!0),e(l,null,n(v.tip.tags,t=>(h(),e("span",{key:t,class:"md3-chip"},r(t),1))),128))])])):s("",!0),t("div",J,[t("h2",K,"Commentaires ("+r(v.comments.length)+")",1),t("div",Q,[v.authStore.isAuthenticated?(h(),e("div",X,[t("div",Y,[t("span",Z,"Connecté en tant que "+r(v.authStore.userName),1),t("button",{onClick:u[2]||(u[2]=e=>v.authStore.logout()),class:"btn-logout"},"Déconnexion")]),c(t("textarea",{"onUpdate:modelValue":u[3]||(u[3]=e=>v.newComment=e),placeholder:"Ajoutez votre commentaire...",class:"md3-textarea",rows:"3"},"                ",512),[[m,v.newComment]]),t("button",{onClick:u[4]||(u[4]=(...e)=>v.addComment&&v.addComment(...e)),class:"btn-primary",disabled:!v.newComment.trim()}," Publier ",8,ee)])):(h(),e("div",W,[u[16]||(u[16]=t("p",{class:"auth-prompt-text"},"Connectez-vous pour laisser un commentaire",-1)),t("button",{onClick:u[1]||(u[1]=e=>v.showAuthModal=!0),class:"btn-primary"}," Se connecter ")]))]),v.comments.length?(h(),e("div",te,[(h(!0),e(l,null,n(v.comments,a=>(h(),e("div",{key:a.id,class:"comment-item"},[t("div",ae,[t("div",se,[t("span",oe,r(a.author_name),1),t("span",ie,r(v.formatDate(a.created_at)),1)]),v.canDeleteComment(a)?(h(),e("div",re,[t("button",{onClick:e=>v.deleteComment(a.id),class:"btn-delete",title:"Supprimer le commentaire"},u[17]||(u[17]=[t("i",{class:"material-icons"},"delete",-1)]),8,le)])):s("",!0)]),t("p",ne,r(a.content),1)]))),128))])):(h(),e("div",ce,u[18]||(u[18]=[t("p",{class:"md3-body-medium dinor-text-gray"},"Aucun commentaire pour le moment.",-1)])))])])])):(h(),e("div",me,[u[19]||(u[19]=t("div",{class:"error-icon"},[t("i",{class:"material-icons"},"error_outline")],-1)),u[20]||(u[20]=t("h2",{class:"md3-title-large"},"Astuce introuvable",-1)),u[21]||(u[21]=t("p",{class:"md3-body-large dinor-text-gray"},"L'astuce demandée n'existe pas ou a été supprimée.",-1)),t("div",de,[t("button",{onClick:u[5]||(u[5]=(...e)=>v.goBack&&v.goBack(...e)),class:"btn-secondary"},"Retour aux astuces"),t("button",{onClick:u[6]||(u[6]=(...e)=>v.goHome&&v.goHome(...e)),class:"btn-primary"},"Accueil")])]))]),a(b,{modelValue:v.showShareModal,"onUpdate:modelValue":u[7]||(u[7]=e=>v.showShareModal=e),"share-data":v.shareData},null,8,["modelValue","share-data"]),a(k,{modelValue:v.showAuthModal,"onUpdate:modelValue":u[8]||(u[8]=e=>v.showAuthModal=e)},null,8,["modelValue"])])}],["__scopeId","data-v-76360b2f"]]);export{ue as default};
