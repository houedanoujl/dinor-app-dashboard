import{h as e,i as t,k as a,j as n,l as o,t as s,A as l,B as r,D as i,F as d,E as c,r as m,b as u,g as v,p,o as y}from"./vendor.Bvrl98ec.js";import{_ as g,D as h,A as f,S as k,u as _,d as C,e as b}from"./index.dD73OAp8.js";import{u as D}from"./useComments.Dc8klCVx.js";const w={class:"event-detail"},E={class:"md3-main-content"},I={key:0,class:"loading-container"},x={key:1,class:"event-content"},S={key:0,class:"event-hero"},A=["src","alt"],T={class:"event-overlay dinor-gradient-primary"},$={class:"event-badges"},L={key:0,class:"md3-chip event-location"},M={key:1,class:"md3-chip event-category"},R={class:"event-info"},z={class:"event-stats"},j={key:0,class:"stat-item"},N={class:"md3-body-medium"},V={key:1,class:"stat-item"},F={class:"md3-body-medium"},U={key:2,class:"stat-item"},O={class:"md3-body-medium"},B={class:"stat-item"},G={class:"md3-body-medium"},H={class:"stat-item"},P={class:"md3-body-medium"},q={class:"event-details"},Y={class:"detail-item"},Z={class:"md3-body-medium"},J={key:0},K={key:1},Q={key:0},W={key:0,class:"detail-item"},X={class:"md3-body-medium"},ee={class:"calendar-links"},te={class:"calendar-buttons"},ae={key:0,class:"event-description"},ne=["innerHTML"],oe={key:1,class:"event-registration"},se={class:"md3-body-medium"},le={key:0,class:"registration-info"},re={class:"md3-body-small dinor-text-gray"},ie={class:"comments-section"},de={class:"md3-title-medium dinor-text-primary"},ce={class:"add-comment-form"},me={key:0,class:"auth-prompt"},ue={key:1},ve={class:"authenticated-user"},pe={class:"user-info"},ye=["disabled"],ge={key:0,class:"comments-list"},he={class:"comment-header"},fe={class:"comment-meta"},ke={class:"comment-author md3-body-medium"},_e={class:"comment-date md3-body-small dinor-text-gray"},Ce={key:0,class:"comment-actions"},be=["onClick"],De={class:"comment-content md3-body-medium"},we={key:1,class:"empty-comments"},Ee={key:2,class:"error-state"},Ie={class:"error-icon"},xe={class:"error-actions"};const Se=g({name:"EventDetail",emits:["update-header"],components:{ShareModal:k,AuthModal:f,DinorIcon:h},props:{id:{type:String,required:!0}},setup(e,{emit:t}){const a=p(),n=_(),o=C(),{showShareModal:s,updateOpenGraphTags:l}=b(),{comments:r,loadComments:i,canDeleteComment:d,deleteComment:c,setContext:y,addComment:g}=D(),h=m(null),f=m(!0),k=m(!1),w=m(!1),E=m(""),I=m(!1),x=u(()=>h.value?{title:h.value.title,text:`Ne manquez pas cet événement : ${h.value.title}`,url:window.location.href,image:h.value.image,type:"event",id:h.value.id}:{}),S=async()=>{try{const t=await n.get("/likes/check",{type:"event",id:e.id});k.value=t.success&&t.is_liked}catch(t){console.error("Erreur lors de la vérification du like:",t)}},A=async()=>{try{const t=await n.get("/favorites/check",{type:"event",id:e.id});w.value=t.success&&t.is_favorited}catch(t){console.error("Erreur lors de la vérification du favori:",t)}},T=(e,t)=>{if(!e)return"";const a=new Date(e);if(t){const[e,n]=t.split(":");a.setHours(parseInt(e),parseInt(n))}return a.toISOString().replace(/[-:]/g,"").replace(/\.\d{3}/,"")};return v(()=>{(async()=>{try{const a=await n.get(`/events/${e.id}`);a.success&&(h.value=a.data,y("Event",e.id),await i(),await S(),await A(),l(x.value),t("update-header",{title:h.value.title||"Événement",showShare:!0,showFavorite:!0,favoriteType:"event",favoriteItemId:parseInt(e.id),isContentFavorited:w.value,backPath:"/events"}))}catch(a){console.error("Erreur lors du chargement de l'événement:",a)}finally{f.value=!1}})()}),{event:h,comments:r,loading:f,userLiked:k,userFavorited:w,newComment:E,toggleLike:async()=>{try{const a=await n.post("/likes/toggle",{likeable_type:"event",likeable_id:e.id});a.success&&(k.value=!k.value,h.value&&(h.value.likes_count=a.data.total_likes),t("update-header",{isLiked:k.value}))}catch(a){console.error("Erreur lors du toggle like:",a)}},toggleFavorite:async()=>{try{const a=await n.post("/favorites/toggle",{favoritable_type:"event",favoritable_id:e.id});a.success&&(w.value=!w.value,h.value&&(h.value.favorites_count=a.data.total_favorites),t("update-header",{isContentFavorited:w.value}))}catch(a){console.error("Erreur lors du toggle favori:",a)}},addComment:async()=>{if(E.value.trim())if(o.isAuthenticated)try{console.log("📝 [Comments] Envoi du commentaire pour Event:",e.id),await g("Event",e.id,E.value),console.log("✅ [Comments] Commentaire ajouté avec succès"),E.value=""}catch(t){console.error("❌ [Comments] Erreur lors de l'ajout du commentaire:",t),(t.message.includes("401")||t.message.includes("connecté"))&&(I.value=!0)}else I.value=!0},canDeleteComment:d,deleteComment:c,goBack:()=>{a.push("/events")},goHome:()=>{a.push("/")},formatEventDate:e=>e?new Date(e).toLocaleDateString("fr-FR",{weekday:"short",day:"numeric",month:"short"}):"",formatEventDateDetailed:e=>e?new Date(e).toLocaleDateString("fr-FR",{weekday:"long",year:"numeric",month:"long",day:"numeric"}):"",formatTime:e=>{if(!e)return"";if(e.match(/^\d{2}:\d{2}$/))return e;try{return new Date(e).toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"})}catch{return e}},formatCommentDate:e=>{if(!e)return"";const t=new Date,a=new Date(e),n=t-a,o=Math.floor(n/864e5),s=Math.floor(n/36e5),l=Math.floor(n/6e4);return l<1?"À l'instant":l<60?`Il y a ${l} min`:s<24?`Il y a ${s} h`:o<7?`Il y a ${o} jour${o>1?"s":""}`:a.toLocaleDateString("fr-FR",{day:"numeric",month:"short",year:a.getFullYear()!==t.getFullYear()?"numeric":void 0})},formatDate:e=>e?new Date(e).toLocaleDateString("fr-FR"):"",handleImageError:e=>{e.target.src="/images/default-recipe.jpg"},formatContent:e=>e?"string"==typeof e?e:Array.isArray(e)?e.map((e,t)=>"object"==typeof e&&e.step?`<div class="content-step">\n              <h4>Étape ${t+1}</h4>\n              <p>${e.step}</p>\n            </div>`:"string"==typeof e?`<div class="content-step">\n              <p>${e}</p>\n            </div>`:`<div class="content-step"><p>${e}</p></div>`).join(""):e.toString():"",showShareModal:s,shareData:x,authStore:o,showAuthModal:I,addToGoogleCalendar:()=>{if(!h.value)return;const e=encodeURIComponent(h.value.title),t=encodeURIComponent(h.value.content?h.value.content.replace(/<[^>]*>/g,""):""),a=encodeURIComponent(h.value.location||""),n=`https://calendar.google.com/calendar/render?action=TEMPLATE&text=${e}&dates=${T(h.value.start_date,h.value.start_time)}/${T(h.value.end_date||h.value.start_date,h.value.end_time||h.value.start_time)}&details=${t}&location=${a}&sf=true&output=xml`;window.open(n,"_blank")},addToIcal:()=>{if(!h.value)return;const e=h.value.title,t=h.value.content?h.value.content.replace(/<[^>]*>/g,""):"",a=h.value.location||"",n=T(h.value.start_date,h.value.start_time),o=T(h.value.end_date||h.value.start_date,h.value.end_time||h.value.start_time),s=`BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//Dinor//Event//EN\nBEGIN:VEVENT\nUID:${h.value.id}@dinor.com\nDTSTART:${n}\nDTEND:${o}\nSUMMARY:${e}\nDESCRIPTION:${t}\nLOCATION:${a}\nEND:VEVENT\nEND:VCALENDAR`,l=new Blob([s],{type:"text/calendar;charset=utf-8"}),r=URL.createObjectURL(l),i=document.createElement("a");i.href=r,i.download=`${e.replace(/[^a-zA-Z0-9]/g,"_")}.ics`,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(r)}}}},[["render",function(m,u,v,p,g,h){const f=o("DinorIcon"),k=o("ShareModal"),_=o("AuthModal");return y(),e("div",w,[t("main",E,[p.loading?(y(),e("div",I,u[11]||(u[11]=[t("div",{class:"md3-circular-progress"},null,-1),t("p",{class:"md3-body-large"},"Chargement de l'événement...",-1)]))):p.event?(y(),e("div",x,[p.event.featured_image_url?(y(),e("div",S,[t("img",{src:p.event.featured_image_url||"/images/default-recipe.jpg",alt:p.event.title,class:"event-hero-image",onError:u[0]||(u[0]=(...e)=>p.handleImageError&&p.handleImageError(...e))},null,40,A),t("div",T,[t("div",$,[p.event.location?(y(),e("div",L,[a(f,{name:"location_on",size:16}),t("span",null,s(p.event.location),1)])):n("",!0),p.event.category?(y(),e("div",M,[a(f,{name:"tag",size:16}),t("span",null,s(p.event.category.name),1)])):n("",!0)])])])):n("",!0),t("div",R,[t("div",z,[p.event.start_date?(y(),e("div",j,[a(f,{name:"calendar_today",size:16}),t("span",N,s(p.formatEventDate(p.event.start_date)),1)])):n("",!0),p.event.start_time?(y(),e("div",V,[a(f,{name:"schedule",size:16}),t("span",F,s(p.formatTime(p.event.start_time)),1)])):n("",!0),p.event.location?(y(),e("div",U,[a(f,{name:"place",size:16}),t("span",O,s(p.event.location),1)])):n("",!0),t("div",B,[a(f,{name:"favorite",size:16}),t("span",G,s(p.event.likes_count||0),1)]),t("div",H,[a(f,{name:"comment",size:16}),t("span",P,s(p.event.comments_count||0),1)])]),t("div",q,[t("div",Y,[u[12]||(u[12]=t("h3",{class:"md3-title-small dinor-text-primary"},"Date et Heure",-1)),t("p",Z,[l(s(p.formatEventDateDetailed(p.event.start_date))+" ",1),p.event.start_time?(y(),e("span",J," à "+s(p.formatTime(p.event.start_time)),1)):n("",!0),p.event.end_date&&p.event.end_date!==p.event.start_date?(y(),e("span",K,[l(" - "+s(p.formatEventDateDetailed(p.event.end_date))+" ",1),p.event.end_time?(y(),e("span",Q," à "+s(p.formatTime(p.event.end_time)),1)):n("",!0)])):n("",!0)])]),p.event.location?(y(),e("div",W,[u[13]||(u[13]=t("h3",{class:"md3-title-small dinor-text-primary"},"Lieu",-1)),t("p",X,s(p.event.location),1)])):n("",!0)]),t("div",ee,[u[16]||(u[16]=t("h3",{class:"md3-title-small dinor-text-primary"},"Ajouter à votre agenda",-1)),t("div",te,[t("button",{onClick:u[1]||(u[1]=(...e)=>p.addToGoogleCalendar&&p.addToGoogleCalendar(...e)),class:"calendar-button google-calendar"},[a(f,{name:"event",size:16}),u[14]||(u[14]=l(" Google Calendar "))]),t("button",{onClick:u[2]||(u[2]=(...e)=>p.addToIcal&&p.addToIcal(...e)),class:"calendar-button ical"},[a(f,{name:"calendar_month",size:16}),u[15]||(u[15]=l(" iCal / Outlook "))])])]),p.event.content?(y(),e("div",ae,[u[17]||(u[17]=t("h2",{class:"md3-title-medium dinor-text-primary"},"Description",-1)),t("div",{class:"md3-body-large dinor-text-gray",innerHTML:p.formatContent(p.event.content)},null,8,ne)])):n("",!0),p.event.registration_required?(y(),e("div",oe,[u[19]||(u[19]=t("h3",{class:"md3-title-small dinor-text-primary"},"Inscription",-1)),t("p",se,[a(f,{name:"info",size:16,class:"dinor-text-secondary"}),u[18]||(u[18]=l(" Inscription requise pour cet événement "))]),p.event.max_attendees?(y(),e("div",le,[t("p",re," Places limitées: "+s(p.event.max_attendees)+" personnes maximum ",1)])):n("",!0)])):n("",!0),t("div",ie,[t("h2",de,"Commentaires ("+s(p.comments.length)+")",1),t("div",ce,[p.authStore.isAuthenticated?(y(),e("div",ue,[t("div",ve,[t("span",pe,"Connecté en tant que "+s(p.authStore.userName),1),t("button",{onClick:u[4]||(u[4]=e=>p.authStore.logout()),class:"btn-logout"},"Déconnexion")]),r(t("textarea",{"onUpdate:modelValue":u[5]||(u[5]=e=>p.newComment=e),placeholder:"Ajoutez votre commentaire...",class:"md3-textarea",rows:"3"},"                ",512),[[i,p.newComment]]),t("button",{onClick:u[6]||(u[6]=(...e)=>p.addComment&&p.addComment(...e)),class:"btn-primary",disabled:!p.newComment.trim()}," Publier ",8,ye)])):(y(),e("div",me,[u[20]||(u[20]=t("p",{class:"auth-prompt-text"},"Connectez-vous pour laisser un commentaire",-1)),t("button",{onClick:u[3]||(u[3]=e=>p.showAuthModal=!0),class:"btn-primary"}," Se connecter ")]))]),p.comments.length?(y(),e("div",ge,[(y(!0),e(d,null,c(p.comments,o=>(y(),e("div",{key:o.id,class:"comment-item"},[t("div",he,[t("div",fe,[t("span",ke,s(o.author_name),1),t("span",_e,s(p.formatDate(o.created_at)),1)]),p.canDeleteComment(o)?(y(),e("div",Ce,[t("button",{onClick:e=>p.deleteComment(o.id),class:"btn-delete",title:"Supprimer le commentaire"},[a(f,{name:"delete",size:16})],8,be)])):n("",!0)]),t("p",De,s(o.content),1)]))),128))])):(y(),e("div",we,u[21]||(u[21]=[t("p",{class:"md3-body-medium dinor-text-gray"},"Aucun commentaire pour le moment.",-1)])))])])])):(y(),e("div",Ee,[t("div",Ie,[a(f,{name:"error",size:64})]),u[22]||(u[22]=t("h2",{class:"md3-title-large"},"Événement introuvable",-1)),u[23]||(u[23]=t("p",{class:"md3-body-large dinor-text-gray"},"L'événement demandé n'existe pas ou a été supprimé.",-1)),t("div",xe,[t("button",{onClick:u[7]||(u[7]=(...e)=>p.goBack&&p.goBack(...e)),class:"btn-secondary"},"Retour aux événements"),t("button",{onClick:u[8]||(u[8]=(...e)=>p.goHome&&p.goHome(...e)),class:"btn-primary"},"Accueil")])]))]),a(k,{modelValue:p.showShareModal,"onUpdate:modelValue":u[9]||(u[9]=e=>p.showShareModal=e),"share-data":p.shareData},null,8,["modelValue","share-data"]),a(_,{modelValue:p.showAuthModal,"onUpdate:modelValue":u[10]||(u[10]=e=>p.showAuthModal=e)},null,8,["modelValue"])])}],["__scopeId","data-v-3f2d15ca"]]);export{Se as default};
