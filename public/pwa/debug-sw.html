<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Service Worker - Dinor PWA</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .button { padding: 10px 20px; margin: 10px; background: #f59e0b; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        #log { background: #f8f9fa; padding: 15px; border-radius: 4px; max-height: 400px; overflow-y: auto; font-family: monospace; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>Debug Service Worker - Dinor PWA</h1>
    
    <div class="controls">
        <button class="button" onclick="registerSW()">Enregistrer SW</button>
        <button class="button" onclick="unregisterSW()">Désenregistrer SW</button>
        <button class="button" onclick="updateSW()">Forcer Mise à Jour</button>
        <button class="button" onclick="clearCaches()">Vider les Caches</button>
        <button class="button" onclick="checkSWStatus()">Vérifier Status</button>
        <button class="button" onclick="clearLog()">Vider Log</button>
    </div>

    <div id="status" class="status info">
        Prêt pour les tests du Service Worker
    </div>

    <div id="log"></div>

    <script>
        const statusDiv = document.getElementById('status');
        const logDiv = document.getElementById('log');
        
        let registration = null;
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            
            // Mettre à jour le statut
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
        }
        
        function clearLog() {
            logDiv.textContent = '';
        }
        
        async function registerSW() {
            if (!('serviceWorker' in navigator)) {
                log('Service Workers non supportés', 'error');
                return;
            }
            
            try {
                log('Enregistrement du Service Worker...', 'info');
                registration = await navigator.serviceWorker.register('/sw.js', {
                    scope: '/pwa/'
                });
                
                log(`SW enregistré avec succès: ${registration.scope}`, 'success');
                
                // Écouter les mises à jour
                registration.addEventListener('updatefound', () => {
                    log('Nouvelle version du SW trouvée', 'warning');
                    const newWorker = registration.installing;
                    
                    newWorker.addEventListener('statechange', () => {
                        log(`État du nouveau SW: ${newWorker.state}`, 'info');
                        if (newWorker.state === 'installed') {
                            log('Nouveau SW installé, redémarrage en cours...', 'warning');
                            window.location.reload();
                        }
                    });
                });
                
            } catch (error) {
                log(`Erreur d'enregistrement SW: ${error.message}`, 'error');
            }
        }
        
        async function unregisterSW() {
            try {
                const registrations = await navigator.serviceWorker.getRegistrations();
                for (let registration of registrations) {
                    await registration.unregister();
                    log(`SW désenregistré: ${registration.scope}`, 'warning');
                }
            } catch (error) {
                log(`Erreur de désenregistrement: ${error.message}`, 'error');
            }
        }
        
        async function updateSW() {
            if (!registration) {
                log('Aucun SW enregistré', 'error');
                return;
            }
            
            try {
                log('Vérification des mises à jour...', 'info');
                await registration.update();
                log('Vérification terminée', 'success');
            } catch (error) {
                log(`Erreur de mise à jour: ${error.message}`, 'error');
            }
        }
        
        async function clearCaches() {
            try {
                const cacheNames = await caches.keys();
                log(`Suppression de ${cacheNames.length} caches...`, 'info');
                
                for (const cacheName of cacheNames) {
                    await caches.delete(cacheName);
                    log(`Cache supprimé: ${cacheName}`, 'warning');
                }
                
                log('Tous les caches supprimés', 'success');
            } catch (error) {
                log(`Erreur de suppression des caches: ${error.message}`, 'error');
            }
        }
        
        async function checkSWStatus() {
            if (!('serviceWorker' in navigator)) {
                log('Service Workers non supportés', 'error');
                return;
            }
            
            try {
                const registration = await navigator.serviceWorker.getRegistration('/pwa/');
                
                if (registration) {
                    log(`SW trouvé: ${registration.scope}`, 'success');
                    
                    if (registration.active) {
                        log(`SW actif: ${registration.active.scriptURL}`, 'info');
                        log(`État: ${registration.active.state}`, 'info');
                    }
                    
                    if (registration.installing) {
                        log('SW en cours d\'installation', 'warning');
                    }
                    
                    if (registration.waiting) {
                        log('SW en attente', 'warning');
                    }
                } else {
                    log('Aucun SW enregistré', 'warning');
                }
                
                // Vérifier les caches
                const cacheNames = await caches.keys();
                log(`Caches existants: ${cacheNames.join(', ')}`, 'info');
                
            } catch (error) {
                log(`Erreur de vérification: ${error.message}`, 'error');
            }
        }
        
        // Auto-démarrage
        window.addEventListener('load', () => {
            log('Page de debug chargée', 'success');
            checkSWStatus();
        });
        
        // Écouter les messages du SW
        navigator.serviceWorker.addEventListener('message', event => {
            log(`Message du SW: ${event.data}`, 'info');
        });
        
        // Écouter les changements de contrôleur
        navigator.serviceWorker.addEventListener('controllerchange', () => {
            log('Nouveau contrôleur SW activé', 'warning');
        });
    </script>
</body>
</html> 